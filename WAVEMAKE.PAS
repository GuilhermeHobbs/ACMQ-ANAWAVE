{Interface generated by X_MAKE}
{Version 1.6 - 05/08/96}
USES Graph,XView;

TYPE
{.wav files have a header of 44 bytes: }
wavheader=RECORD
  CASE BOOLEAN OF
  FALSE:(
  riff:ARRAY[0..3] of CHAR;    	{ "RIFF" }
  filesize:LONGINT;		{ size of the file }
  wave:ARRAY[0..3] of CHAR;    	{ "WAVE" }
  fmt:ARRAY[0..3] of CHAR;     	{ "fmt " }
  fmtsize:LONGINT;              { 16, in general }
  wFormatTag:INTEGER;		{ 1 for PCM }
  nChannels:INTEGER;		{ 1 for mono, 2 for stereo }
  nSamplesPerSec:LONGINT;	{ sampling frequency (Hz) }
  nAvgBytesPerSec:LONGINT;	{ = nBlockAlign*nSamplesPerSec }
  nBlockAlign:INTEGER;		{ = wBitsPerSample/8 * nChannels }
  wBitsPerSample:INTEGER;	{ 16 or 8 }
  data:ARRAY[0..3] of CHAR;     { "data" }
  datasize:LONGINT;		{ size of the data block (bytes) }
  );
  TRUE: (field:ARRAY[1..22] of INTEGER);
END;

VAR
  saida:FILE of INTEGER;
  i:LONGINT;
  amostras:LONGINT;
  dpi:REAL;
  a1,b1,a2,b2,a3,b3,wa1,wa2,wa3,t,amp1,amp2,amp3: REAL;
  v1,v2,v3,vn,v,an:INTEGER;
  header:wavheader;

{Declaration of the interface objects}
VAR
  fmain,
  tstart1,tstart2,tstart3,tend1,tend2,tend3,
  tampl1,tampl2,tampl3,tampln,
  tname,tsampling,tsamples,bwrite,message1,
  bquit:Xv_opaque;

{$F+}

{Callback procedures}

PROCEDURE NotifyWrite(obj:Xv_opaque);
BEGIN
  {Notify handler for bwrite}
  dpi:=2.0*Pi; amostras:=round(tsamples^.panel_real);
  WITH header DO BEGIN
    riff:='RIFF';
    filesize:=SizeOf(header)-8+Trunc(tsamples^.panel_real)*2;
    wave:='WAVE';
    fmt:='fmt ';
    fmtsize:=16;
    wFormatTag:=1;
    nChannels:=1;
    nSamplesPerSec:=Trunc(tsampling^.panel_real);
    nAvgBytesPerSec:=Trunc(tsampling^.panel_real)*16;
    nBlockAlign:=2;
    wBitsPerSample:=16;
    data:='data';
    datasize:=Trunc(tsamples^.panel_real)*2;
  END;
  Assign(saida,tname^.panel_value);
  ReWrite(saida);
  FOR i:=1 TO 22 DO Write(saida,header.field[i]);
  a1:=dpi*(tend1^.panel_real-tstart1^.panel_real)/tsamples^.panel_real;
  b1:=dpi*tstart1^.panel_real-a1;
  a2:=dpi*(tend2^.panel_real-tstart2^.panel_real)/tsamples^.panel_real;
  b2:=dpi*tstart2^.panel_real-a2;
  a3:=dpi*(tend3^.panel_real-tstart3^.panel_real)/tsamples^.panel_real;
  b3:=dpi*tstart3^.panel_real-a3;
  amp1:=tampl1^.panel_int;
  amp2:=tampl2^.panel_int;
  amp3:=tampl3^.panel_int;
  an:=tampln^.panel_int;
  FOR i:=1 TO amostras DO BEGIN
    wa1:=a1/2*i+b1; {/2!}
    wa2:=a2/2*i+b2;
    wa3:=a3/2*i+b3;
    t:=i/tsampling^.panel_real;
    v1:=Round(amp1*cos(wa1*t));
    v2:=Round(amp2*cos(wa2*t));
    v3:=Round(amp3*cos(wa3*t));
    vn:=2*Random(an)-an;
    v:=v1+v2+v3+vn;
    Write(saida,v);
  END;
  Close(saida);
  xv_set(message1,'File '+tname^.panel_value+' written.');
END;

PROCEDURE NotifyQuit(obj:Xv_opaque);
BEGIN
  {Notify handler for bquit}
  xv_end:=TRUE;
END;

{$F-}

BEGIN
  {Inicialization}
  xv_init(0,0);
  {Menu creation}
  {Interface objects creation}
  fmain:=xv_create(frame);
  WITH fmain^ DO BEGIN
    xv_label:='Wave Maker';
    x:=19;
    y:=10;
    dx:=599;
    dy:=159;
  END;
  tstart1:=xv_create(textfield);
  WITH tstart1^ DO BEGIN
    xv_label:='Start 1';
    value_length:=10;
    field_type:=real_field;
    panel_real:=0;
  END;
  tstart2:=xv_create(textfield);
  WITH tstart2^ DO BEGIN
    xv_label:='Start 2';
    y:=15;
    value_length:=10;
    field_type:=real_field;
    panel_real:=5000;
  END;
  tstart3:=xv_create(textfield);
  WITH tstart3^ DO BEGIN
    xv_label:='Start 3';
    y:=30;
    value_length:=10;
    field_type:=real_field;
    panel_real:=4000;
  END;
  tend1:=xv_create(textfield);
  WITH tend1^ DO BEGIN
    xv_label:='End 1';
    x:=153;
    value_length:=10;
    field_type:=real_field;
    panel_real:=5000;
  END;
  tend2:=xv_create(textfield);
  WITH tend2^ DO BEGIN
    xv_label:='End 2';
    x:=153;
    y:=15;
    value_length:=10;
    field_type:=real_field;
    panel_real:=1000;
  END;
  tend3:=xv_create(textfield);
  WITH tend3^ DO BEGIN
    xv_label:='End 3';
    x:=153;
    y:=30;
    value_length:=10;
    field_type:=real_field;
    panel_real:=0;
  END;
  tampl1:=xv_create(textfield);
  WITH tampl1^ DO BEGIN
    xv_label:='Amplitude 1';
    x:=290;
    value_length:=10;
    field_type:=int_field;
    min_value:=0;
    panel_int:=10000;
  END;
  tampl2:=xv_create(textfield);
  WITH tampl2^ DO BEGIN
    xv_label:='Amplitude 2';
    x:=290;
    y:=15;
    value_length:=10;
    field_type:=int_field;
    min_value:=0;
    panel_int:=10000;
  END;
  tampl3:=xv_create(textfield);
  WITH tampl3^ DO BEGIN
    xv_label:='Amplitude 3';
    x:=290;
    y:=30;
    value_length:=10;
    field_type:=int_field;
    min_value:=0;
    panel_int:=10000;
  END;
  tampln:=xv_create(textfield);
  WITH tampln^ DO BEGIN
    xv_label:='Noise amplitude';
    y:=47;
    value_length:=10;
    field_type:=int_field;
    min_value:=0;
    panel_int:=1000;
  END;
  tname:=xv_create(textfield);
  WITH tname^ DO BEGIN
    xv_label:='File name (.wav)';
    y:=90;
    panel_value:='sample.wav';
  END;
  tsampling:=xv_create(textfield);
  WITH tsampling^ DO BEGIN
    xv_label:='Sampling rate';
    y:=75;
    field_type:=real_field;
    panel_real:=11025;
  END;
  tsamples:=xv_create(textfield);
  WITH tsamples^ DO BEGIN
    xv_label:='Number of samples';
    x:=255;
    y:=75;
    field_type:=real_field;
    panel_real:=50000;
  END;
  bwrite:=xv_create(button);
  WITH bwrite^ DO BEGIN
    xv_label:='Write file';
    y:=105;
    notify_handler:=NotifyWrite;
  END;
  message1:=xv_create(message);
  WITH message1^ DO BEGIN
    xv_label:='*';
    x:=99;
    y:=119;
  END;
  bquit:=xv_create(button);
  WITH bquit^ DO BEGIN
    xv_label:='Quit';
    y:=120;
    notify_handler:=NotifyQuit;
  END;
  xv_main_loop(fmain);
  {Exit}
  RestoreCrtMode;
END.
